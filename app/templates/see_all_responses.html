{% extends "base.html" %}

{% block title %}Response Database{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Response Database</h1>
        <div>
            <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-house"></i> Home
            </a>
        </div>
    </div>

    <!-- Filters Card -->
    <div class="card mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Filter Options</h5>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
                <i class="bi bi-funnel"></i> Toggle Filters
            </button>
        </div>
        <div class="collapse show" id="filterCollapse">
            <div class="card-body">
                <form method="GET" action="{{ url_for('main.view_responses') }}" class="row g-3">
                    <div class="col-md-3">
                        <label for="provider" class="form-label">Provider:</label>
                        <select class="form-select" id="provider" name="provider">
                            <option value="">All Providers</option>
                            {% for provider in providers %}
                                <option value="{{ provider.provider_name }}" {% if current_filters.provider == provider.provider_name %}selected{% endif %}>
                                    {{ provider.provider_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="model" class="form-label">Model:</label>
                        <select class="form-select" id="model" name="model">
                            <option value="">All Models</option>
                            {% for model in models %}
                                <option value="{{ model.name }}" {% if current_filters.model == model.name %}selected{% endif %}>
                                    {{ model.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="question_id" class="form-label">Question:</label>
                        <select class="form-select" id="question_id" name="question_id">
                            <option value="">All Questions</option>
                            {% for question in questions %}
                                <option value="{{ question.question_id }}" {% if current_filters.question_id|string == question.question_id|string %}selected{% endif %}>
                                    {{ question.content|truncate(30) }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="story_id" class="form-label">Story ID:</label>
                        <input type="text" class="form-control" id="story_id" name="story_id"
                               value="{{ current_filters.story_id }}">
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" id="flagged_only" name="flagged_only" 
                                   value="true" {% if current_filters.flagged_only %}checked{% endif %}>
                            <label class="form-check-label" for="flagged_only">
                                Show only flagged responses
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">Apply Filters</button>
                        <a href="{{ url_for('main.view_responses') }}" class="btn btn-secondary">Reset</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Results count -->
    <p>Showing 
        {% if pagination.page * pagination.per_page - pagination.per_page + 1 <= pagination.total %}
            {{ pagination.page * pagination.per_page - pagination.per_page + 1 }} â€“
            {% if pagination.page * pagination.per_page < pagination.total %}
                {{ pagination.page * pagination.per_page }}
            {% else %}
                {{ pagination.total }}
            {% endif %}
            of {{ pagination.total }}
        {% else %}
            0 of 0
        {% endif %}
        responses
    </p>

    <!-- Responses Table -->
    <div class="card mb-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover table-sm mb-0">
                    <thead>
                        <tr>
                            <th style="width: 60px;">ID</th>
                            <th style="width: 100px;">Provider</th>
                            <th style="width: 120px;">Model</th>
                            <th>Parameters</th>
                            <th>Story</th>
                            <th>Question</th>
                            <th>Response</th>
                            <th style="width: 80px;">Flagged</th>
                            <th>Review Notes</th>
                            <th style="width: 120px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for response in responses %}
                        <tr>
                            <td>{{ response.response_id }}</td>
                            <td>{{ response.prompt.model.provider.provider_name }}</td>
                            <td>{{ response.prompt.model.name }}</td>
                            <td style="max-width: 200px; overflow-wrap: break-word;">
                                {% if response.prompt.payload %}
                                    <ul class="list-unstyled mb-0 small">
                                        <li><strong>Temperature:</strong> {{ response.prompt.temperature }}</li>
                                        <li><strong>Max Tokens:</strong> {{ response.prompt.max_tokens }}</li>
                                        <li><strong>Top P:</strong> {{ response.prompt.top_p }}</li>
                                    </ul>
                                {% else %}
                                    <em class="text-muted">None</em>
                                {% endif %}
                            </td>
                            <td>
                                <div class="text-truncate" style="max-width: 200px;" title="{{ response.prompt.story.content }}">
                                    {{ response.prompt.story.content|truncate(100) }}
                                </div>
                                <small class="text-muted">ID: {{ response.prompt.story_id }}</small>
                            </td>
                            <td>
                                <div class="text-truncate" style="max-width: 200px;" title="{{ response.prompt.question.content }}">
                                    {{ response.prompt.question.content|truncate(100) }}
                                </div>
                                <small class="text-muted">ID: {{ response.prompt.question_id }}</small>
                            </td>
                            <td>
                                <div style="max-height: 150px; overflow-y: auto; max-width: 250px; overflow-wrap: break-word;">
                                    {{ response.response_content }}
                                </div>
                            </td>
                            <td class="text-center">
                                {% if response.flagged_for_review %}
                                    <span class="badge bg-danger">Flagged</span>
                                {% else %}
                                    <span class="badge bg-success">OK</span>
                                {% endif %}
                            </td>
                            <td>
                                <form action="{{ url_for('main.view_responses', **request.args) }}" method="POST">
                                    <input type="hidden" name="response_id" value="{{ response.response_id }}">
                                    
                                    <!-- Flag control -->
                                    <div class="form-check mb-2">
                                        <input type="checkbox" id="flagged_{{ response.response_id }}" 
                                              name="flagged_for_review_{{ response.response_id }}" 
                                              class="form-check-input"
                                              {% if response.flagged_for_review %}checked{% endif %}
                                              onchange="this.form.submit()">
                                        <label class="form-check-label" for="flagged_{{ response.response_id }}">
                                            {% if response.flagged_for_review %}
                                                <span class="text-danger">Flagged</span>
                                            {% else %}
                                                <span class="text-success">Not Flagged</span>
                                            {% endif %}
                                        </label>
                                    </div>
                                    
                                    <!-- Review notes -->
                                    <textarea name="review_notes_{{ response.response_id }}" 
                                              class="form-control review-notes-area" 
                                              rows="3">{{ response.review_notes or '' }}</textarea>
                                    
                                    <!-- Submit button -->
                                    <button type="submit" class="btn btn-sm btn-primary mt-2 w-100">Save</button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center">No responses found matching your criteria</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if pagination.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('main.view_responses', page=pagination.prev_num, provider=current_filters.provider, model=current_filters.model, flagged_only='true' if current_filters.flagged_only else '', question_id=current_filters.question_id, story_id=current_filters.story_id) }}">Previous</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}
            
            {% for page_num in pagination.iter_pages() %}
                {% if page_num %}
                    <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('main.view_responses', page=page_num, provider=current_filters.provider, model=current_filters.model, flagged_only='true' if current_filters.flagged_only else '', question_id=current_filters.question_id, story_id=current_filters.story_id) }}">{{ page_num }}</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}
            
            {% if pagination.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('main.view_responses', page=pagination.next_num, provider=current_filters.provider, model=current_filters.model, flagged_only='true' if current_filters.flagged_only else '', question_id=current_filters.question_id, story_id=current_filters.story_id) }}">Next</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
        </ul>
    </nav>
</div>

<!-- Edit Modals -->
{% for response in responses %}
<div class="modal fade" id="editModal{{ response.response_id }}" tabindex="-1" aria-labelledby="editModalLabel{{ response.response_id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel{{ response.response_id }}">Edit Response #{{ response.response_id }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm{{ response.response_id }}" method="POST" action="{{ url_for('main.view_responses', **request.args) }}">
                    <input type="hidden" name="response_id" value="{{ response.response_id }}">
                    
                    <div class="mb-3">
                        <label class="form-label">Provider:</label>
                        <input type="text" class="form-control" value="{{ response.prompt.model.provider.provider_name }}" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Model:</label>
                        <input type="text" class="form-control" value="{{ response.prompt.model.name }}" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Timestamp:</label>
                        <input type="text" class="form-control" value="{{ response.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Story:</label>
                        <textarea class="form-control" rows="3" disabled>{{ response.prompt.story.content }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Question:</label>
                        <textarea class="form-control" rows="2" disabled>{{ response.prompt.question.content }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Response:</label>
                        <textarea class="form-control" rows="5" disabled>{{ response.response_content }}</textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="flagged{{ response.response_id }}" 
                               name="flagged_for_review_{{ response.response_id }}" {% if response.flagged_for_review %}checked{% endif %}>
                        <label class="form-check-label" for="flagged{{ response.response_id }}">Flag for review</label>
                    </div>
                    <div class="mb-3">
                        <label for="notes{{ response.response_id }}" class="form-label">Review Notes:</label>
                        <textarea class="form-control" id="notes{{ response.response_id }}" 
                                  name="review_notes_{{ response.response_id }}" rows="3">{{ response.review_notes }}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" form="editForm{{ response.response_id }}" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
    // Function to quickly toggle flag status
    function toggleFlag(responseId, flagged) {
        // Send AJAX request to update flag status
        fetch('{{ url_for("main.update_response_flag") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                response_id: responseId,
                flagged: flagged
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the page to show updated data
                location.reload();
            } else {
                alert('Error updating flag status: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the flag status');
        });
    }
</script>
{% endblock %}